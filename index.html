<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mymap ¬∑ –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: #1a2a1a;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
            font-family: monospace;
        }
        #loginScreen {
            background: #2a3a2a;
            border-radius: 52px;
            padding: 40px;
            box-shadow: 0 35px 50px #000000e0;
            color: #d0e0d0;
            width: min(400px, 90vw);
        }
        #loginScreen h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            text-shadow: 3px 3px 0 #1a2a1a;
            letter-spacing: 4px;
        }
        .input-group {
            margin-bottom: 25px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            text-align: center;
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            background: #1a2a1a;
            border: 3px solid #4a7a4a;
            border-radius: 30px;
            color: #d0e0d0;
            font-size: 18px;
            font-family: monospace;
            outline: none;
            text-align: center;
        }
        .input-group input:focus {
            border-color: #7cb57c;
        }
        .color-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .color-option {
            aspect-ratio: 1;
            border-radius: 15px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: 0.1s;
        }
        .color-option.selected {
            border-color: white;
            transform: scale(1.05);
            box-shadow: 0 0 15px white;
        }
        .color-white { background: #ffffff; }
        .color-black { background: #222222; }
        .color-red { background: #ff4444; }
        .color-orange { background: #ff8844; }
        .color-yellow { background: #ffff44; }
        .color-green { background: #44ff44; }
        .color-cyan { background: #44ffff; }
        .color-blue { background: #4444ff; }
        .color-pink { background: #ff88ff; }
        .color-purple { background: #aa44ff; }
        
        #createRoomBtn {
            width: 100%;
            padding: 18px;
            background: #4a7a4a;
            border: none;
            border-radius: 40px;
            color: #d0e0d0;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 0 #1a2a1a;
            margin-top: 20px;
            transition: 0.05s linear;
            font-family: monospace;
        }
        #createRoomBtn:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #1a2a1a;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Å—ã–ª–∫–∏ */
        .room-link-container {
            width: 100%;
            margin-bottom: 10px;
            padding: 12px;
            background: #1a2a1a;
            border-radius: 20px;
            border: 2px solid #7cb57c;
        }
        .room-link-label {
            text-align: center;
            color: #a0d0a0;
            font-size: 13px;
            margin-bottom: 8px;
        }
        .room-link-input {
            width: 100%;
            padding: 10px;
            background: #2a3a2a;
            border: 2px solid #4a7a4a;
            border-radius: 15px;
            color: #ffffa0;
            font-size: 13px;
            font-family: monospace;
            text-align: center;
            word-break: break-all;
            margin-bottom: 8px;
        }
        .copy-btn {
            width: 100%;
            padding: 10px;
            background: #4a7a4a;
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #1a2a1a;
            transition: 0.05s linear;
        }
        .copy-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #1a2a1a;
        }
        
        #errorMsg {
            color: #ff8888;
            text-align: center;
            margin-top: 15px;
            min-height: 25px;
        }
        
        .game {
            background: #2a3a2a;
            border-radius: 42px;
            padding: 20px;
            box-shadow: 0 35px 50px #000000e0;
        }
        .game-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .coords {
            color: #d0e0d0;
            font-family: monospace;
            font-size: 16px;
            text-align: center;
            text-shadow: 2px 2px 0 #1a2a1a;
            letter-spacing: 2px;
        }
        .header-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .exit-btn, .reset-btn {
            background: #4a3a3a;
            color: #ffb0b0;
            border: none;
            border-radius: 25px;
            padding: 5px 25px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #2a1a1a;
            transition: 0.05s linear;
            font-family: monospace;
        }
        .reset-btn {
            background: #3a4a3a;
            color: #b0ffb0;
            box-shadow: 0 4px 0 #1a2a1a;
        }
        .exit-btn:active, .reset-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #2a1a1a;
        }
        canvas {
            display: block;
            width: min(380px, 80vw);
            height: min(380px, 80vw);
            background: #7cb57c;
            border-radius: 36px;
            box-shadow: inset 0 0 0 4px #4a7a4a;
            margin: 0 auto;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-left: 5px;
        }
        .action-btn {
            width: min(60px, 13vw);
            height: min(60px, 13vw);
            border-radius: 25px;
            background: #3a4a3a;
            box-shadow: 0 6px 0 #1a2a1a, inset 0 -3px 8px #5a7a5a;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            touch-action: none;
            transition: 0.05s linear;
            font-size: 28px;
            color: #ff6b6b;
        }
        .action-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #1a2a1a, inset 0 -3px 8px #5a7a5a;
        }
        .joystick-wrapper {
            margin-right: 5px;
        }
        .joystick {
            width: min(120px, 26vw);
            height: min(120px, 26vw);
            background: #3a4a3a;
            border-radius: 999px;
            box-shadow: 0 8px 0 #1a2a1a, inset 0 -4px 12px #5a7a5a;
            position: relative;
            touch-action: none;
        }
        .thumb {
            position: absolute;
            width: 42px;
            height: 42px;
            background: #7cb57c;
            border-radius: 999px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 7px 14px #1a2a1a, 0 0 0 4px #4a7a4a;
            transition: transform 0.02s;
            will-change: transform;
        }
        .info-panel {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
            z-index: 10;
        }
        .player-list {
            color: #a0d0a0;
            font-size: 11px;
            background: #1a2a1a80;
            padding: 5px 8px;
            border-radius: 8px;
            max-width: 150px;
            pointer-events: none;
            backdrop-filter: blur(2px);
            border: 1px solid #5a7a5a;
        }
        .counter {
            color: #d0e0d0;
            font-size: 12px;
            font-weight: normal;
            background: #1a2a1a80;
            padding: 5px 10px;
            border: 1px solid #5a7a5a;
            border-radius: 10px;
            text-shadow: 2px 2px 3px rgba(0,0,0,0.8);
            pointer-events: none;
            backdrop-filter: blur(2px);
        }
        .game-wrapper {
            position: relative;
        }
        .code-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #00000080;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .code-dialog.hidden {
            display: none;
        }
        .code-box {
            background: #2a3a2a;
            padding: 25px;
            border-radius: 35px;
            box-shadow: 0 20px 30px #000000;
            border: 3px solid #5a7a5a;
            width: min(280px, 75vw);
        }
        .code-box h3 {
            color: #d0e0d0;
            text-align: center;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .code-box input {
            width: 100%;
            padding: 12px;
            background: #1a2a1a;
            border: 3px solid #4a7a4a;
            border-radius: 25px;
            color: #d0e0d0;
            font-size: 20px;
            font-family: monospace;
            outline: none;
            text-align: center;
            letter-spacing: 3px;
            margin-bottom: 15px;
        }
        .code-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .code-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.05s linear;
            font-family: monospace;
        }
        .code-btn.submit {
            background: #4a7a4a;
            color: #d0e0d0;
            box-shadow: 0 4px 0 #1a2a1a;
        }
        .code-btn.cancel {
            background: #4a3a3a;
            color: #ffb0b0;
            box-shadow: 0 4px 0 #2a1a1a;
        }
        .code-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #1a2a1a;
        }
        .connection-status {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #a0d0a0;
            font-size: 11px;
            background: #1a2a1a80;
            padding: 3px 6px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div id="loginScreen">
        <h2>MYMAP</h2>
        <div class="input-group">
            <label>–¢–í–û–Å –ò–ú–Ø (3-20 —Å–∏–º–≤–æ–ª–æ–≤, a-z, 0-9, _)</label>
            <input type="text" id="nameInput" maxlength="20">
        </div>
        <div class="input-group">
            <label>–¶–í–ï–¢</label>
            <div class="color-grid" id="colorGrid"></div>
        </div>
        <button id="createRoomBtn">–°–û–ó–î–ê–¢–¨ –ö–û–ú–ù–ê–¢–£</button>
        <div id="joinPanel" style="margin-top: 15px; display: none;">
            <input type="text" id="roomIdInput" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" style="width:100%; padding:15px; margin-bottom:10px; background:#1a2a1a; border:3px solid #4a7a4a; border-radius:30px; color:#d0e0d0; font-size:18px; text-align:center;">
            <button id="joinRoomBtn" style="width:100%; padding:15px; background:#4a7a4a; border:none; border-radius:40px; color:#d0e0d0; font-size:20px; font-weight:bold; cursor:pointer; box-shadow:0 6px 0 #1a2a1a;">–ü–†–ò–°–û–ï–î–ò–ù–ò–¢–¨–°–Ø</button>
        </div>
        <div id="errorMsg"></div>
    </div>

    <div class="game" id="gameScreen" style="display: none;">
        <div class="game-header">
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Å—ã–ª–∫–∏ -->
            <div id="roomLinkContainer" class="room-link-container" style="display: none;">
                <div class="room-link-label">üì± –°–°–´–õ–ö–ê –î–õ–Ø –î–†–£–ì–ê:</div>
                <input type="text" id="roomLinkInput" class="room-link-input" readonly>
                <button class="copy-btn" id="copyLinkBtn">–ö–û–ü–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£</button>
            </div>
            
            <div class="coords" id="coordsDisplay">X: 0 | Y: 0</div>
            <div class="header-buttons">
                <button class="reset-btn" id="resetBtn">–°–ë–†–û–°</button>
                <button class="exit-btn" id="exitBtn">–í–´–•–û–î</button>
            </div>
        </div>
        <div class="game-wrapper">
            <div class="info-panel">
                <div class="player-list" id="playerList"></div>
                <div class="counter" id="counter">0/10</div>
            </div>
            <canvas id="world" width="600" height="600"></canvas>
            <div class="connection-status" id="connectionStatus"></div>
        </div>
        <div class="controls">
            <div class="action-buttons">
                <div class="action-btn" id="deleteBtn">‚úï</div>
                <div class="action-btn" id="createBtn"></div>
            </div>
            <div class="joystick-wrapper">
                <div class="joystick" id="joystick">
                    <div class="thumb" id="thumb"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="code-dialog hidden" id="codeDialog">
        <div class="code-box">
            <h3>üîê –í–í–ï–î–ò –ö–û–î</h3>
            <input type="text" id="codeInput" maxlength="7" placeholder="0000000">
            <div class="code-buttons">
                <button class="code-btn submit" id="submitCode">OK</button>
                <button class="code-btn cancel" id="cancelCode">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <script>
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ
        function getRandomPlayerNumber() {
            const num = Math.floor(Math.random() * 999) + 1;
            return num.toString().padStart(3, '0');
        }
        
        document.getElementById('nameInput').value = 'Player_' + getRandomPlayerNumber();
        
        // –¶–≤–µ—Ç–∞
        const colors = [
            'white', 'black', 'red', 'orange', 'yellow',
            'green', 'cyan', 'blue', 'pink', 'purple'
        ];
        
        let selectedColor = 'white';
        let myId = 'player_' + Math.random().toString(36).substr(2, 9);
        let myName = '';
        let isHost = false;
        let currentRoomId = '';
        
        // –°–µ—Ç–∫–∞ —Ü–≤–µ—Ç–æ–≤
        const colorGrid = document.getElementById('colorGrid');
        colors.forEach(color => {
            const div = document.createElement('div');
            div.className = `color-option color-${color}`;
            if (color === 'white') div.classList.add('selected');
            div.onclick = () => {
                document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
                selectedColor = color;
            };
            colorGrid.appendChild(div);
        });
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let players = new Map();
        let playerObstacles = [];
        const MAX_PLAYER_OBSTACLES = 10;
        const RESET_CODE = '6787001';
        
        // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
        const staticObstacles = [];
        const WORLD_SIZE = 2000;
        const SPAWN_RADIUS = 400;
        
        for (let i = 0; i < 150; i++) {
            let x, y, dist;
            do {
                x = (Math.random() - 0.5) * WORLD_SIZE;
                y = (Math.random() - 0.5) * WORLD_SIZE;
                dist = Math.hypot(x, y);
            } while (dist < SPAWN_RADIUS);
            
            const shape = Math.floor(Math.random() * 3);
            let w, h;
            
            switch(shape) {
                case 0: w = h = 30 + Math.random() * 50; break;
                case 1: w = 50 + Math.random() * 60; h = 25 + Math.random() * 30; break;
                case 2: w = 25 + Math.random() * 30; h = 50 + Math.random() * 60; break;
            }
            
            staticObstacles.push({
                x: x - w/2,
                y: y - h/2,
                w, h
            });
        }
        
        // –ò–≥—Ä–æ–∫
        const player = {
            x: 0,
            y: 0,
            r: 18
        };
        
        // –î–∂–æ–π—Å—Ç–∏–∫
        let drag = false;
        const maxDist = 35;
        const vec = { x: 0, y: 0 };
        const SPEED = 5;
        let lastDir = { x: 0, y: -1 };
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const canvas = document.getElementById('world');
        const ctx = canvas.getContext('2d');
        const joyDiv = document.getElementById('joystick');
        const thumbDiv = document.getElementById('thumb');
        const coordsDiv = document.getElementById('coordsDisplay');
        const createBtn = document.getElementById('createBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const counterDiv = document.getElementById('counter');
        const playerListDiv = document.getElementById('playerList');
        const connectionStatus = document.getElementById('connectionStatus');
        const exitBtn = document.getElementById('exitBtn');
        const resetBtn = document.getElementById('resetBtn');
        const codeDialog = document.getElementById('codeDialog');
        const codeInput = document.getElementById('codeInput');
        const submitCode = document.getElementById('submitCode');
        const cancelCode = document.getElementById('cancelCode');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã
        const roomLinkContainer = document.getElementById('roomLinkContainer');
        const roomLinkInput = document.getElementById('roomLinkInput');
        const copyBtn = document.getElementById('copyLinkBtn');
        const joinPanel = document.getElementById('joinPanel');
        const roomIdInput = document.getElementById('roomIdInput');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        
        // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        let syncInterval = null;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            if (!currentRoomId) {
                joinPanel.style.display = 'block';
            }
        }, 2000);
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        document.getElementById('createRoomBtn').onclick = () => {
            const name = document.getElementById('nameInput').value.trim();
            
            if (!validateName(name)) return;
            
            myName = name;
            isHost = true;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∫–æ–º–Ω–∞—Ç—ã (6 —Ü–∏—Ñ—Ä)
            currentRoomId = Math.floor(100000 + Math.random() * 900000).toString();
            
            // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
            const link = `${window.location.origin}${window.location.pathname}?join=${currentRoomId}`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è
            players.set(myId, {
                id: myId,
                name: myName,
                color: selectedColor,
                x: 0, y: 0,
                lastDir: { x: 0, y: -1 },
                r: 18
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            saveGameData();
            
            showGame();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
            roomLinkContainer.style.display = 'block';
            roomLinkInput.value = link;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            joinPanel.style.display = 'none';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
            startSync();
        };
        
        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
        joinRoomBtn.onclick = () => {
            const name = document.getElementById('nameInput').value.trim();
            const roomId = roomIdInput.value.trim();
            
            if (!roomId || roomId.length !== 6 || !/^\d+$/.test(roomId)) {
                document.getElementById('errorMsg').textContent = '–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã';
                return;
            }
            
            if (!validateName(name)) return;
            
            myName = name;
            currentRoomId = roomId;
            isHost = false;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã
            loadGameData();
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è
            players.set(myId, {
                id: myId,
                name: myName,
                color: selectedColor,
                x: 0, y: 0,
                lastDir: { x: 0, y: -1 },
                r: 18
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å –Ω–æ–≤—ã–º –∏–≥—Ä–æ–∫–æ–º)
            saveGameData();
            
            showGame();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            joinPanel.style.display = 'none';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
            startSync();
        };
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
        copyBtn.onclick = () => {
            roomLinkInput.select();
            navigator.clipboard.writeText(roomLinkInput.value).then(() => {
                copyBtn.textContent = '–ì–û–¢–û–í–û!';
                setTimeout(() => {
                    copyBtn.textContent = '–ö–û–ü–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£';
                }, 2000);
            });
        };
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–ö–ê–ñ–î–´–ï 50 –ú–° –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)
        function startSync() {
            if (syncInterval) clearInterval(syncInterval);
            
            syncInterval = setInterval(() => {
                if (currentRoomId) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ—é –ø–æ–∑–∏—Ü–∏—é
                    const myPlayer = players.get(myId);
                    if (myPlayer) {
                        myPlayer.x = player.x;
                        myPlayer.y = player.y;
                        myPlayer.lastDir = lastDir;
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                    saveGameData();
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö
                    loadGameData();
                }
            }, 50);
        }
        
        function saveGameData() {
            const data = {
                players: Array.from(players.values()),
                obstacles: playerObstacles,
                timestamp: Date.now()
            };
            localStorage.setItem('mymap_' + currentRoomId, JSON.stringify(data));
        }
        
        function loadGameData() {
            const saved = localStorage.getItem('mymap_' + currentRoomId);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤–æ—é –ø–æ–∑–∏—Ü–∏—é
                    const myX = player.x;
                    const myY = player.y;
                    const myLastDir = { ...lastDir };
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
                    players.clear();
                    data.players.forEach(p => {
                        players.set(p.id, p);
                    });
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤–æ—é –ø–æ–∑–∏—Ü–∏—é (–æ–Ω–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –º–µ–Ω—è—Ç—å—Å—è –æ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
                    const myPlayer = players.get(myId);
                    if (myPlayer) {
                        myPlayer.x = myX;
                        myPlayer.y = myY;
                        myPlayer.lastDir = myLastDir;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
                    playerObstacles = data.obstacles || [];
                    
                    updatePlayerList();
                    updateCounter();
                } catch(e) {}
            }
        }
        
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ localStorage (–¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
        window.addEventListener('storage', (e) => {
            if (e.key === 'mymap_' + currentRoomId) {
                loadGameData();
            }
        });
        
        function validateName(name) {
            if (name.length < 3 || name.length > 20 || !/^[a-zA-Z0-9_]+$/.test(name)) {
                document.getElementById('errorMsg').textContent = '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∏–º—è';
                return false;
            }
            return true;
        }
        
        function showGame() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            connectionStatus.textContent = isHost ? 'üü¢ –•–æ—Å—Ç' : 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ ' + currentRoomId;
            updatePlayerList();
            updateCounter();
        }
        
        function resetGame() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            
            playerObstacles = [];
            players.clear();
            
            if (currentRoomId) {
                localStorage.removeItem('mymap_' + currentRoomId);
            }
            
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            roomLinkContainer.style.display = 'none';
            joinPanel.style.display = 'block';
            roomIdInput.value = '';
            
            player.x = 0;
            player.y = 0;
            lastDir = { x: 0, y: -1 };
            document.getElementById('nameInput').value = 'Player_' + getRandomPlayerNumber();
            
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        exitBtn.onclick = resetGame;
        
        resetBtn.onclick = () => {
            codeDialog.classList.remove('hidden');
            codeInput.value = '';
            codeInput.focus();
        };
        
        submitCode.onclick = () => {
            const code = codeInput.value.trim();
            if (code === RESET_CODE) {
                if (isHost) {
                    resetGame();
                } else {
                    alert('–¢–æ–ª—å–∫–æ —Ö–æ—Å—Ç –º–æ–∂–µ—Ç —Å–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É!');
                }
                codeDialog.classList.add('hidden');
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥!');
                codeInput.value = '';
            }
        };
        
        cancelCode.onclick = () => {
            codeDialog.classList.add('hidden');
        };
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !codeDialog.classList.contains('hidden')) {
                codeDialog.classList.add('hidden');
            }
        });
        
        function updatePlayerList() {
            const list = Array.from(players.values())
                .map(p => `<span style="color: ${getColor(p.color)}">‚óè</span> ${p.name}${p.id === myId ? ' (–≤—ã)' : ''}`)
                .join('<br>');
            playerListDiv.innerHTML = `üë• –ò–≥—Ä–æ–∫–∏ (${players.size}):<br>${list}`;
        }
        
        function canMoveTo(nx, ny, r) {
            for (let ob of staticObstacles) {
                const nearX = Math.max(ob.x, Math.min(nx, ob.x + ob.w));
                const nearY = Math.max(ob.y, Math.min(ny, ob.y + ob.h));
                const d = Math.hypot(nx - nearX, ny - nearY);
                if (d < r) return false;
            }
            
            for (let ob of playerObstacles) {
                const nearX = Math.max(ob.x, Math.min(nx, ob.x + ob.w));
                const nearY = Math.max(ob.y, Math.min(ny, ob.y + ob.h));
                const d = Math.hypot(nx - nearX, ny - nearY);
                if (d < r) return false;
            }
            
            for (let p of players.values()) {
                if (p.id === myId) continue;
                const d = Math.hypot(nx - p.x, ny - p.y);
                if (d < r + (p.r || 18)) return false;
            }
            
            return true;
        }
        
        function move(dx, dy) {
            if (dx === 0 && dy === 0) return;
            
            if (canMoveTo(player.x + dx, player.y + dy, player.r)) {
                player.x += dx;
                player.y += dy;
                return;
            }
            
            if (canMoveTo(player.x + dx, player.y, player.r)) {
                player.x += dx;
            }
            
            if (canMoveTo(player.x, player.y + dy, player.r)) {
                player.y += dy;
            }
        }
        
        function createObstacle() {
            const myObstacles = playerObstacles.filter(o => o.playerId === myId).length;
            if (myObstacles >= MAX_PLAYER_OBSTACLES) return;
            
            const len = Math.hypot(lastDir.x, lastDir.y);
            if (len < 0.1) return;
            
            const dirX = lastDir.x / len;
            const dirY = lastDir.y / len;
            
            const createDist = player.r + 40;
            const newX = player.x + dirX * createDist;
            const newY = player.y + dirY * createDist;
            
            const w = 44;
            const h = 44;
            const x = newX - w/2;
            const y = newY - h/2;
            
            const tempObstacle = { x, y, w, h };
            
            for (let ob of staticObstacles) {
                if (rectCollide(tempObstacle, ob)) return;
            }
            
            for (let ob of playerObstacles) {
                if (rectCollide(tempObstacle, ob)) return;
            }
            
            for (let p of players.values()) {
                const d = Math.hypot(newX - p.x, newY - p.y);
                if (d < player.r + w/2) return;
            }
            
            const obstacle = {
                playerId: myId,
                playerColor: selectedColor,
                x, y, w, h
            };
            
            playerObstacles.push(obstacle);
            saveGameData();
            updateCounter();
        }
        
        function deleteObstacleAtDot() {
            const len = Math.hypot(lastDir.x, lastDir.y);
            if (len < 0.1) return;
            
            const dirX = lastDir.x / len;
            const dirY = lastDir.y / len;
            
            const dotDist = 12 + 25;
            const dotX = player.x + dirX * (player.r + dotDist);
            const dotY = player.y + dirY * (player.r + dotDist);
            
            for (let i = 0; i < playerObstacles.length; i++) {
                const ob = playerObstacles[i];
                if (dotX >= ob.x && dotX <= ob.x + ob.w &&
                    dotY >= ob.y && dotY <= ob.y + ob.h) {
                    if (ob.playerId === myId) {
                        playerObstacles.splice(i, 1);
                        saveGameData();
                        updateCounter();
                    }
                    return;
                }
            }
        }
        
        function rectCollide(r1, r2) {
            return !(r2.x >= r1.x + r1.w ||
                     r2.x + r2.w <= r1.x ||
                     r2.y >= r1.y + r1.h ||
                     r2.y + r2.h <= r1.y);
        }
        
        function updateCoords() {
            const x = Math.round(player.x);
            const y = Math.round(player.y);
            coordsDiv.textContent = `X: ${x}  |  Y: ${y}`;
        }
        
        function updateCounter() {
            const myObstacles = playerObstacles.filter(o => o.playerId === myId).length;
            counterDiv.textContent = `${myObstacles}/${MAX_PLAYER_OBSTACLES}`;
        }
        
        function onStart(e) {
            e.preventDefault();
            drag = true;
            onMove(e);
        }
        
        function onMove(e) {
            if (!drag) return;
            e.preventDefault();
            
            const rect = joyDiv.getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            
            let x, y;
            if (e.touches) {
                x = e.touches[0].clientX;
                y = e.touches[0].clientY;
            } else {
                x = e.clientX;
                y = e.clientY;
            }
            
            let dx = x - cx;
            let dy = y - cy;
            const dist = Math.hypot(dx, dy);
            
            if (dist > maxDist) {
                dx = (dx / dist) * maxDist;
                dy = (dy / dist) * maxDist;
            }
            
            thumbDiv.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            
            if (dist > 0.1) {
                vec.x = dx / maxDist;
                vec.y = dy / maxDist;
                lastDir.x = vec.x;
                lastDir.y = vec.y;
            } else {
                vec.x = 0;
                vec.y = 0;
            }
        }
        
        function onEnd(e) {
            e.preventDefault();
            drag = false;
            thumbDiv.style.transform = 'translate(-50%, -50%)';
            vec.x = 0;
            vec.y = 0;
        }
        
        createBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            createObstacle();
        });
        createBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            createObstacle();
        });
        
        deleteBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            deleteObstacleAtDot();
        });
        deleteBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            deleteObstacleAtDot();
        });
        
        joyDiv.addEventListener('mousedown', onStart);
        joyDiv.addEventListener('mousemove', onMove);
        joyDiv.addEventListener('mouseup', onEnd);
        joyDiv.addEventListener('mouseleave', onEnd);
        
        joyDiv.addEventListener('touchstart', onStart, { passive: false });
        joyDiv.addEventListener('touchmove', onMove, { passive: false });
        joyDiv.addEventListener('touchend', onEnd);
        joyDiv.addEventListener('touchcancel', onEnd);
        joyDiv.addEventListener('contextmenu', e => e.preventDefault());
        
        function getColor(colorName) {
            switch(colorName) {
                case 'white': return '#ffffff';
                case 'black': return '#222222';
                case 'red': return '#ff4444';
                case 'orange': return '#ff8844';
                case 'yellow': return '#ffff44';
                case 'green': return '#44ff44';
                case 'cyan': return '#44ffff';
                case 'blue': return '#4444ff';
                case 'pink': return '#ff88ff';
                case 'purple': return '#aa44ff';
                default: return '#7fd4ff';
            }
        }
        
        function draw() {
            ctx.clearRect(0, 0, 600, 600);
            
            const camX = player.x - 300;
            const camY = player.y - 300;
            
            ctx.fillStyle = '#7cb57c';
            ctx.fillRect(0, 0, 600, 600);
            
            ctx.fillStyle = '#5a4f4a';
            ctx.shadowColor = '#3a2f2a';
            ctx.shadowBlur = 18;
            
            for (let ob of staticObstacles) {
                const screenX = ob.x - camX;
                const screenY = ob.y - camY;
                if (screenX + ob.w > -50 && screenX < 650 && screenY + ob.h > -50 && screenY < 650) {
                    ctx.fillRect(screenX, screenY, ob.w, ob.h);
                }
            }
            
            for (let ob of playerObstacles) {
                const screenX = ob.x - camX;
                const screenY = ob.y - camY;
                if (screenX + ob.w > -50 && screenX < 650 && screenY + ob.h > -50 && screenY < 650) {
                    ctx.shadowColor = '#2a7080';
                    ctx.beginPath();
                    ctx.arc(screenX + ob.w/2, screenY + ob.h/2, ob.w/2, 0, Math.PI*2);
                    ctx.fillStyle = getColor(ob.playerColor);
                    ctx.fill();
                    ctx.strokeStyle = '#3f7080';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
            
            for (let p of players.values()) {
                if (p.id === myId) continue;
                
                const screenX = 300 + (p.x - player.x);
                const screenY = 300 + (p.y - player.y);
                
                if (screenX > -50 && screenX < 650 && screenY > -50 && screenY < 650) {
                    ctx.shadowBlur = 28;
                    ctx.shadowColor = '#4aa0c0';
                    ctx.beginPath();
                    ctx.arc(screenX, screenY, p.r || 18, 0, Math.PI*2);
                    ctx.fillStyle = getColor(p.color);
                    ctx.fill();
                    ctx.shadowBlur = 10;
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    ctx.shadowBlur = 4;
                    ctx.shadowColor = '#000000';
                    ctx.font = 'bold 14px monospace';
                    ctx.fillStyle = '#ffffff';
                    ctx.textAlign = 'center';
                    ctx.fillText(p.name, screenX, screenY - 28);
                    
                    if (p.lastDir) {
                        const len = Math.hypot(p.lastDir.x, p.lastDir.y);
                        if (len > 0.1) {
                            const dirX = p.lastDir.x / len;
                            const dirY = p.lastDir.y / len;
                            const dotX = screenX + dirX * 30;
                            const dotY = screenY + dirY * 30;
                            
                            ctx.shadowBlur = 0;
                            ctx.beginPath();
                            ctx.arc(dotX, dotY, 5, 0, Math.PI*2);
                            ctx.fillStyle = '#6a6a6a';
                            ctx.fill();
                        }
                    }
                }
            }
            
            ctx.shadowBlur = 28;
            ctx.shadowColor = '#4aa0c0';
            ctx.beginPath();
            ctx.arc(300, 300, player.r, 0, Math.PI*2);
            ctx.fillStyle = getColor(selectedColor);
            ctx.fill();
            ctx.shadowBlur = 10;
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.shadowBlur = 4;
            ctx.shadowColor = '#000000';
            ctx.font = 'bold 14px monospace';
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center';
            ctx.fillText(myName, 300, 300 - 28);
            
            const dirToUse = drag ? vec : lastDir;
            const len = Math.hypot(dirToUse.x, dirToUse.y);
            if (len > 0.1) {
                const dirX = dirToUse.x / len;
                const dirY = dirToUse.y / len;
                
                let distFromPlayer;
                if (drag) {
                    distFromPlayer = 12 + (len * 25);
                } else {
                    distFromPlayer = 12 + 25;
                }
                
                const dotX = 300 + dirX * (player.r + distFromPlayer);
                const dotY = 300 + dirY * (player.r + distFromPlayer);
                
                ctx.shadowBlur = 0;
                ctx.beginPath();
                ctx.arc(dotX, dotY, 6, 0, Math.PI*2);
                ctx.fillStyle = '#6a6a6a';
                ctx.fill();
            }
            
            ctx.shadowBlur = 0;
            ctx.beginPath();
            ctx.arc(300 - player.x, 300 - player.y, 14, 0, 2*Math.PI);
            ctx.fillStyle = '#ffffff60';
            ctx.fill();
            ctx.strokeStyle = '#ffffffa0';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            updatePlayerList();
        }
        
        function loop() {
            if (drag) {
                move(vec.x * SPEED, vec.y * SPEED);
            }
            updateCoords();
            draw();
            requestAnimationFrame(loop);
        }
        
        loop();
    </script>
</body>
</html>