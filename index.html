<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–∫–∞–º–µ–Ω–Ω—ã–π –ª–µ—Å ¬∑ –ø–æ—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–µ–Ω</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: #1a2a1a;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }
        .game {
            background: #2a3a2a;
            border-radius: 52px;
            padding: 26px;
            box-shadow: 0 35px 50px #000000e0;
        }
        canvas {
            display: block;
            width: min(420px, 85vw);
            height: min(420px, 85vw);
            background: #7cb57c;
            border-radius: 42px;
            box-shadow: inset 0 0 0 4px #4a7a4a;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            gap: 15px;
        }
        .action-btn {
            width: min(70px, 15vw);
            height: min(70px, 15vw);
            border-radius: 30px;
            background: #3a4a3a;
            box-shadow: 0 8px 0 #1a2a1a, inset 0 -3px 10px #5a7a5a;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: #d0e0d0;
            cursor: pointer;
            touch-action: none;
            transition: 0.05s linear;
        }
        .action-btn:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #1a2a1a, inset 0 -3px 10px #5a7a5a;
        }
        .joystick-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
        }
        .joystick {
            width: min(140px, 28vw);
            height: min(140px, 28vw);
            background: #3a4a3a;
            border-radius: 999px;
            box-shadow: 0 10px 0 #1a2a1a, inset 0 -5px 16px #5a7a5a;
            position: relative;
            touch-action: none;
        }
        .thumb {
            position: absolute;
            width: 48px;
            height: 48px;
            background: #7cb57c;
            border-radius: 999px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 9px 18px #1a2a1a, 0 0 0 5px #4a7a4a;
            transition: transform 0.02s;
            will-change: transform;
        }
        .coords {
            color: #d0e0d0;
            font-family: monospace;
            font-size: 18px;
            text-align: center;
            margin-bottom: 12px;
            text-shadow: 2px 2px 0 #1a2a1a;
            letter-spacing: 2px;
        }
        .counter {
            position: absolute;
            top: 45px;
            right: 55px;
            background: #2a3a2a;
            color: #d0e0d0;
            font-family: monospace;
            font-size: 22px;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 30px;
            box-shadow: 0 5px 0 #1a2a1a;
            border: 2px solid #4a7a4a;
            z-index: 10;
        }
        .game-wrapper {
            position: relative;
        }
    </style>
</head>
<body>
<div class="game">
    <div class="game-wrapper">
        <div class="counter" id="counter">0/10</div>
        <div class="coords" id="coordsDisplay">X: 0 | Y: 0</div>
        <canvas id="world" width="600" height="600"></canvas>
    </div>
    <div class="controls">
        <div class="action-btn" id="deleteBtn">üóëÔ∏è</div>
        <div class="joystick-wrapper">
            <div class="joystick" id="joystick">
                <div class="thumb" id="thumb"></div>
            </div>
        </div>
        <div class="action-btn" id="createBtn">‚ûï</div>
    </div>
</div>

<script>
    (function() {
        const canvas = document.getElementById('world');
        const ctx = canvas.getContext('2d');
        const joyDiv = document.getElementById('joystick');
        const thumbDiv = document.getElementById('thumb');
        const coordsDiv = document.getElementById('coordsDisplay');
        const createBtn = document.getElementById('createBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const counterDiv = document.getElementById('counter');

        // –∏–≥—Ä–æ–∫ –°–¢–ê–†–¢–£–ï–¢ –í (0, 0)
        const player = {
            x: 0,
            y: 0,
            r: 18
        };

        // –¥–∂–æ–π—Å—Ç–∏–∫
        let drag = false;
        const maxDist = 35;
        const vec = { x: 0, y: 0 };
        const SPEED = 5;

        // –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ï –ü–†–ï–ü–Ø–¢–°–¢–í–ò–Ø (—Ç–µ–º–Ω–µ–µ)
        const obstacles = [
            // –≥—Ä—É–ø–ø–∞ —Å–ª–µ–≤–∞
            { x: -450, y: -320, w: 70, h: 70, type: 'stone' },
            { x: -520, y: 180, w: 85, h: 85, type: 'stone' },
            { x: -380, y: 450, w: 60, h: 60, type: 'stone' },
            { x: -600, y: -100, w: 90, h: 90, type: 'stone' },
            
            // –≥—Ä—É–ø–ø–∞ —Å–ø—Ä–∞–≤–∞
            { x: 400, y: -420, w: 75, h: 75, type: 'stone' },
            { x: 550, y: -200, w: 100, h: 100, type: 'stone' },
            { x: 480, y: 150, w: 65, h: 65, type: 'stone' },
            { x: 600, y: 350, w: 80, h: 80, type: 'stone' },
            
            // –≥—Ä—É–ø–ø–∞ —Å–≤–µ—Ä—Ö—É
            { x: -200, y: -550, w: 95, h: 95, type: 'stone' },
            { x: 150, y: -600, w: 70, h: 70, type: 'stone' },
            { x: 350, y: -480, w: 85, h: 85, type: 'stone' },
            
            // –≥—Ä—É–ø–ø–∞ —Å–Ω–∏–∑—É
            { x: -250, y: 550, w: 80, h: 80, type: 'stone' },
            { x: 200, y: 520, w: 90, h: 90, type: 'stone' },
            { x: 450, y: 600, w: 75, h: 75, type: 'stone' },
            
            // —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞ (–ø–æ–¥–∞–ª—å—à–µ –æ—Ç —Å—Ç–∞—Ä—Ç–∞)
            { x: -150, y: -150, w: 60, h: 60, type: 'stone' },
            { x: 180, y: 180, w: 70, h: 70, type: 'stone' },
            { x: -200, y: 200, w: 65, h: 65, type: 'stone' },
            { x: 220, y: -180, w: 80, h: 80, type: 'stone' },
            
            // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–∞–º–Ω–∏
            { x: -400, y: -400, w: 100, h: 100, type: 'stone' },
            { x: 500, y: -500, w: 90, h: 90, type: 'stone' },
            { x: -500, y: 500, w: 85, h: 85, type: 'stone' },
            { x: 400, y: 400, w: 95, h: 95, type: 'stone' },
            { x: -100, y: -400, w: 70, h: 70, type: 'stone' },
            { x: 300, y: -300, w: 80, h: 80, type: 'stone' },
            { x: -300, y: 300, w: 75, h: 75, type: 'stone' },
            { x: 100, y: 400, w: 90, h: 90, type: 'stone' },
            
            // –µ—â–µ –∫–∞–º–Ω–∏ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
            { x: -700, y: -200, w: 85, h: 85, type: 'stone' },
            { x: 700, y: 200, w: 95, h: 95, type: 'stone' },
            { x: -650, y: 650, w: 80, h: 80, type: 'stone' },
            { x: 650, y: -650, w: 90, h: 90, type: 'stone' },
            { x: -800, y: 0, w: 75, h: 75, type: 'stone' },
            { x: 800, y: 100, w: 85, h: 85, type: 'stone' },
            { x: 0, y: -800, w: 95, h: 95, type: 'stone' },
            { x: 100, y: 800, w: 80, h: 80, type: 'stone' }
        ];

        // —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–æ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (–≥–æ–ª—É–±—ã–µ)
        let playerObstacles = [];
        const MAX_PLAYER_OBSTACLES = 10;

        // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
        function updateCounter() {
            counterDiv.textContent = `${playerObstacles.length}/${MAX_PLAYER_OBSTACLES}`;
        }

        // –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ –≤—Å–µ–º–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏ (–∏ –∫–∞–º–µ–Ω–Ω—ã–º–∏, –∏ –≥–æ–ª—É–±—ã–º–∏)
        function canMoveTo(nx, ny, r) {
            // –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–º–µ–Ω–Ω—ã—Ö –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
            for (let ob of obstacles) {
                const nearX = Math.max(ob.x, Math.min(nx, ob.x + ob.w));
                const nearY = Math.max(ob.y, Math.min(ny, ob.y + ob.h));
                const d = Math.hypot(nx - nearX, ny - nearY);
                if (d < r) return false;
            }
            
            // –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
            for (let ob of playerObstacles) {
                const nearX = Math.max(ob.x, Math.min(nx, ob.x + ob.w));
                const nearY = Math.max(ob.y, Math.min(ny, ob.y + ob.h));
                const d = Math.hypot(nx - nearX, ny - nearY);
                if (d < r) return false;
            }
            
            return true;
        }

        // –¥–≤–∏–∂–µ–Ω–∏–µ —Å–æ —Å–∫–æ–ª—å–∂–µ–Ω–∏–µ–º
        function move(dx, dy) {
            if (dx === 0 && dy === 0) return;
            
            if (canMoveTo(player.x + dx, player.y + dy, player.r)) {
                player.x += dx;
                player.y += dy;
                return;
            }
            
            if (canMoveTo(player.x + dx, player.y, player.r)) {
                player.x += dx;
            }
            
            if (canMoveTo(player.x, player.y + dy, player.r)) {
                player.y += dy;
            }
        }

        // —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
        function createObstacle() {
            // –ø—Ä–æ–≤–µ—Ä—è–µ–º, –¥–≤–∏–≥–∞–µ—Ç—Å—è –ª–∏ –∏–≥—Ä–æ–∫ (–∫–∞—Å–∞–µ—Ç—Å—è –ª–∏ –¥–∂–æ–π—Å—Ç–∏–∫–∞)
            if (!drag) return;
            
            // –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
            if (playerObstacles.length >= MAX_PLAYER_OBSTACLES) return;
            
            // –ø–æ–∑–∏—Ü–∏—è –ø–µ—Ä–µ–¥ –∏–≥—Ä–æ–∫–æ–º (–∫—É–¥–∞ –æ–Ω —Å–º–æ—Ç—Ä–∏—Ç)
            const len = Math.hypot(vec.x, vec.y);
            if (len < 0.1) return; // –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è
            
            const dirX = vec.x / len;
            const dirY = vec.y / len;
            
            // —Å–æ–∑–¥–∞–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ —á—É—Ç—å –¥–∞–ª—å—à–µ —Ç–æ—á–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const createDist = player.r + 40;
            const newX = player.x + dirX * createDist;
            const newY = player.y + dirY * createDist;
            
            // –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è –ª–∏ —Å –¥—Ä—É–≥–∏–º–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏
            const tempObstacle = {
                x: newX - 22,
                y: newY - 22,
                w: 44,
                h: 44
            };
            
            // –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –∫–∞–º–Ω—è–º–∏
            for (let ob of obstacles) {
                if (rectCollide(tempObstacle, ob)) return;
            }
            
            // –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å –¥—Ä—É–≥–∏–º–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏
            for (let ob of playerObstacles) {
                if (rectCollide(tempObstacle, ob)) return;
            }
            
            // –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å –∏–≥—Ä–æ–∫–æ–º
            const d = Math.hypot(newX - player.x, newY - player.y);
            if (d < player.r + 22) return;
            
            // –¥–æ–±–∞–≤–ª—è–µ–º
            playerObstacles.push({
                x: newX - 22,
                y: newY - 22,
                w: 44,
                h: 44,
                type: 'player'
            });
            
            updateCounter();
        }

        // —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
        function deleteLastObstacle() {
            if (playerObstacles.length > 0) {
                playerObstacles.pop();
                updateCounter();
            }
        }

        // –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤
        function rectCollide(r1, r2) {
            return !(r2.x >= r1.x + r1.w ||
                     r2.x + r2.w <= r1.x ||
                     r2.y >= r1.y + r1.h ||
                     r2.y + r2.h <= r1.y);
        }

        // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        function updateCoords() {
            const x = Math.round(player.x);
            const y = Math.round(player.y);
            coordsDiv.textContent = `X: ${x}  |  Y: ${y}`;
        }

        // –¥–∂–æ–π—Å—Ç–∏–∫
        function onStart(e) {
            e.preventDefault();
            drag = true;
            onMove(e);
        }

        function onMove(e) {
            if (!drag) return;
            e.preventDefault();
            
            const rect = joyDiv.getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            
            let x, y;
            if (e.touches) {
                x = e.touches[0].clientX;
                y = e.touches[0].clientY;
            } else {
                x = e.clientX;
                y = e.clientY;
            }
            
            let dx = x - cx;
            let dy = y - cy;
            const dist = Math.hypot(dx, dy);
            
            if (dist > maxDist) {
                dx = (dx / dist) * maxDist;
                dy = (dy / dist) * maxDist;
            }
            
            thumbDiv.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            
            if (dist > 8) {
                vec.x = dx / maxDist;
                vec.y = dy / maxDist;
            } else {
                vec.x = 0;
                vec.y = 0;
            }
        }

        function onEnd(e) {
            e.preventDefault();
            drag = false;
            thumbDiv.style.transform = 'translate(-50%, -50%)';
            vec.x = 0;
            vec.y = 0;
        }

        // —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫
        createBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            createObstacle();
        });
        createBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            createObstacle();
        });

        deleteBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            deleteLastObstacle();
        });
        deleteBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            deleteLastObstacle();
        });

        // —Å–æ–±—ã—Ç–∏—è –¥–∂–æ–π—Å—Ç–∏–∫–∞
        joyDiv.addEventListener('mousedown', onStart);
        joyDiv.addEventListener('mousemove', onMove);
        joyDiv.addEventListener('mouseup', onEnd);
        joyDiv.addEventListener('mouseleave', onEnd);
        
        joyDiv.addEventListener('touchstart', onStart, { passive: false });
        joyDiv.addEventListener('touchmove', onMove, { passive: false });
        joyDiv.addEventListener('touchend', onEnd);
        joyDiv.addEventListener('touchcancel', onEnd);
        joyDiv.addEventListener('contextmenu', e => e.preventDefault());

        // –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
        function draw() {
            ctx.clearRect(0, 0, 600, 600);
            
            const camX = player.x - 300;
            const camY = player.y - 300;
            
            // —Ç—Ä–∞–≤—è–Ω–æ–π —Ñ–æ–Ω
            ctx.fillStyle = '#7cb57c';
            ctx.fillRect(0, 0, 600, 600);
            
            // –∫–∞–º–Ω–∏ (—Ç–µ–º–Ω–æ-—Å–µ—Ä—ã–µ)
            ctx.fillStyle = '#5a4f4a';  // —Ç–µ–º–Ω–µ–µ
            ctx.shadowColor = '#3a2f2a';
            ctx.shadowBlur = 18;
            
            for (let ob of obstacles) {
                const screenX = ob.x - camX;
                const screenY = ob.y - camY;
                if (screenX + ob.w > -50 && screenX < 650 && screenY + ob.h > -50 && screenY < 650) {
                    ctx.fillRect(screenX, screenY, ob.w, ob.h);
                }
            }
            
            // —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–æ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (–≥–æ–ª—É–±—ã–µ, –∫—Ä—É–≥–ª—ã–µ)
            ctx.shadowColor = '#2a7080';
            for (let ob of playerObstacles) {
                const screenX = ob.x - camX;
                const screenY = ob.y - camY;
                if (screenX + ob.w > -50 && screenX < 650 && screenY + ob.h > -50 && screenY < 650) {
                    ctx.beginPath();
                    ctx.arc(screenX + ob.w/2, screenY + ob.h/2, ob.w/2, 0, Math.PI*2);
                    ctx.fillStyle = '#5fa0c0';  // –≥–æ–ª—É–±–æ–π, –Ω–æ —Ç–µ–º–Ω–µ–µ —á—Ç–æ–±—ã –Ω–µ —Å–ª–∏–≤–∞–ª—Å—è
                    ctx.fill();
                    ctx.strokeStyle = '#3f7080';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
            
            // –∏–≥—Ä–æ–∫ (–≥–æ–ª—É–±–æ–π)
            ctx.shadowBlur = 28;
            ctx.shadowColor = '#4aa0c0';
            ctx.beginPath();
            ctx.arc(300, 300, player.r, 0, Math.PI*2);
            ctx.fillStyle = '#7fd4ff';
            ctx.fill();
            ctx.shadowBlur = 10;
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // —Ç–æ—á–∫–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–µ–º–Ω–æ-—Å–µ—Ä–∞—è, –±–µ–∑ –±–ª–∏–∫–æ–≤)
            const moving = Math.hypot(vec.x, vec.y) > 0.1;
            
            if (moving) {
                const len = Math.hypot(vec.x, vec.y);
                const dirX = vec.x / len;
                const dirY = vec.y / len;
                
                const distFromPlayer = 12 + (len * 25);
                
                const dotX = 300 + dirX * (player.r + distFromPlayer);
                const dotY = 300 + dirY * (player.r + distFromPlayer);
                
                ctx.shadowBlur = 0;
                ctx.beginPath();
                ctx.arc(dotX, dotY, 6, 0, Math.PI*2);
                ctx.fillStyle = '#6a6a6a';  // —Ç–µ–º–Ω–æ-—Å–µ—Ä–∞—è
                ctx.fill();
            }

            // –±–æ–ª—å—à–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –±–µ–ª–∞—è —Ç–æ—á–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ –º–∏—Ä–∞ (0,0)
            ctx.shadowBlur = 0;
            ctx.beginPath();
            ctx.arc(300 - player.x, 300 - player.y, 14, 0, 2*Math.PI);
            ctx.fillStyle = '#ffffff60';
            ctx.fill();
            ctx.strokeStyle = '#ffffffa0';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // —Ü–∏–∫–ª
        function loop() {
            move(vec.x * SPEED, vec.y * SPEED);
            updateCoords();
            draw();
            requestAnimationFrame(loop);
        }
        
        updateCounter();
        loop();
    })();
</script>
</body>
</html>