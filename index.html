<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>кружок · свободно</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: #0c101a;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }
        .game {
            background: #16202e;
            border-radius: 48px;
            padding: 24px;
            box-shadow: 0 30px 45px #000000d9;
        }
        canvas {
            display: block;
            width: min(330px, 70vw);
            height: min(330px, 70vw);
            background: #222c42;
            border-radius: 36px;
            box-shadow: inset 0 0 0 3px #344561;
        }
        .pad {
            display: flex;
            justify-content: center;
            margin-top: 22px;
        }
        .joystick {
            width: min(125px, 26vw);
            height: min(125px, 26vw);
            background: #1e263f;
            border-radius: 999px;
            box-shadow: 0 9px 0 #11162a, inset 0 -4px 14px #2f3e64;
            position: relative;
            touch-action: none;
        }
        .thumb {
            position: absolute;
            width: 44px;
            height: 44px;
            background: #b8d2ff;
            border-radius: 999px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 8px 16px #1d2448, 0 0 0 4px #314672;
            transition: transform 0.02s;
            will-change: transform;
        }
    </style>
</head>
<body>
<div class="game">
    <canvas id="world" width="500" height="500"></canvas>
    <div class="pad">
        <div class="joystick" id="joystick">
            <div class="thumb" id="thumb"></div>
        </div>
    </div>
</div>

<script>
    (function() {
        const canvas = document.getElementById('world');
        const ctx = canvas.getContext('2d');
        const joyDiv = document.getElementById('joystick');
        const thumbDiv = document.getElementById('thumb');

        // игрок
        const player = {
            x: 0,
            y: 0,
            r: 14
        };

        // джойстик
        let drag = false;
        const maxDist = 30;
        const vec = { x: 0, y: 0 };
        const SPEED = 3.8;

        // препятствия (редкие)
        const blocks = new Map();
        const BLOCK = 50;

        // генерация блока - ТОЛЬКО 15% заполненность
        function getBlock(wx, wy) {
            const gx = Math.floor(wx / BLOCK) * BLOCK;
            const gy = Math.floor(wy / BLOCK) * BLOCK;
            const key = gx + '|' + gy;
            
            if (blocks.has(key)) return blocks.get(key);
            
            // случайно, но стабильно для координат
            const hash = Math.abs(gx * 374761393 + gy * 668265263) % 100;
            if (hash < 15) { // 15% стен, 85% пустота
                const b = { 
                    x: gx, 
                    y: gy, 
                    w: BLOCK * 0.8, // чуть меньше, чтобы не слипались
                    h: BLOCK * 0.8
                };
                blocks.set(key, b);
                return b;
            } else {
                blocks.set(key, null);
                return null;
            }
        }

        // проверка столкновения
        function canMoveTo(nx, ny, r) {
            const minX = Math.floor((nx - r) / BLOCK);
            const maxX = Math.floor((nx + r) / BLOCK);
            const minY = Math.floor((ny - r) / BLOCK);
            const maxY = Math.floor((ny + r) / BLOCK);
            
            for (let gy = minY; gy <= maxY; gy++) {
                for (let gx = minX; gx <= maxX; gx++) {
                    const b = getBlock(gx * BLOCK + BLOCK/2, gy * BLOCK + BLOCK/2);
                    if (!b) continue;
                    
                    const nearX = Math.max(b.x, Math.min(nx, b.x + b.w));
                    const nearY = Math.max(b.y, Math.min(ny, b.y + b.h));
                    const d = Math.hypot(nx - nearX, ny - nearY);
                    if (d < r) return false;
                }
            }
            return true;
        }

        // движение со скольжением
        function move(dx, dy) {
            if (dx === 0 && dy === 0) return;
            
            if (canMoveTo(player.x + dx, player.y + dy, player.r)) {
                player.x += dx;
                player.y += dy;
                return;
            }
            
            if (canMoveTo(player.x + dx, player.y, player.r)) {
                player.x += dx;
            }
            
            if (canMoveTo(player.x, player.y + dy, player.r)) {
                player.y += dy;
            }
        }

        // джойстик
        function onStart(e) {
            e.preventDefault();
            drag = true;
            onMove(e);
        }

        function onMove(e) {
            if (!drag) return;
            e.preventDefault();
            
            const rect = joyDiv.getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            
            let x, y;
            if (e.touches) {
                x = e.touches[0].clientX;
                y = e.touches[0].clientY;
            } else {
                x = e.clientX;
                y = e.clientY;
            }
            
            let dx = x - cx;
            let dy = y - cy;
            const dist = Math.hypot(dx, dy);
            
            if (dist > maxDist) {
                dx = (dx / dist) * maxDist;
                dy = (dy / dist) * maxDist;
            }
            
            thumbDiv.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            
            if (dist > 7) {
                vec.x = dx / maxDist;
                vec.y = dy / maxDist;
            } else {
                vec.x = 0;
                vec.y = 0;
            }
        }

        function onEnd(e) {
            e.preventDefault();
            drag = false;
            thumbDiv.style.transform = 'translate(-50%, -50%)';
            vec.x = 0;
            vec.y = 0;
        }

        // события
        joyDiv.addEventListener('mousedown', onStart);
        joyDiv.addEventListener('mousemove', onMove);
        joyDiv.addEventListener('mouseup', onEnd);
        joyDiv.addEventListener('mouseleave', onEnd);
        
        joyDiv.addEventListener('touchstart', onStart, { passive: false });
        joyDiv.addEventListener('touchmove', onMove, { passive: false });
        joyDiv.addEventListener('touchend', onEnd);
        joyDiv.addEventListener('touchcancel', onEnd);
        joyDiv.addEventListener('contextmenu', e => e.preventDefault());

        // отрисовка
        function draw() {
            ctx.clearRect(0, 0, 500, 500);
            
            const camX = player.x - 250;
            const camY = player.y - 250;
            
            // стены (редкие)
            ctx.fillStyle = '#7d6b55';
            ctx.shadowColor = '#4a3f30';
            ctx.shadowBlur = 16;
            
            const sx = Math.floor((camX - BLOCK) / BLOCK);
            const ex = Math.floor((camX + 500 + BLOCK) / BLOCK);
            const sy = Math.floor((camY - BLOCK) / BLOCK);
            const ey = Math.floor((camY + 500 + BLOCK) / BLOCK);
            
            for (let gy = sy; gy <= ey; gy++) {
                for (let gx = sx; gx <= ex; gx++) {
                    const b = getBlock(gx * BLOCK + BLOCK/2, gy * BLOCK + BLOCK/2);
                    if (!b) continue;
                    ctx.fillRect(b.x - camX, b.y - camY, b.w, b.h);
                }
            }
            
            // игрок
            ctx.shadowBlur = 26;
            ctx.shadowColor = '#7fa3f0';
            ctx.beginPath();
            ctx.arc(250, 250, player.r, 0, Math.PI*2);
            ctx.fillStyle = '#dceeff';
            ctx.fill();
            ctx.shadowBlur = 9;
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // глазки
            ctx.shadowBlur = 0;
            ctx.beginPath();
            ctx.arc(241, 241, 4, 0, 2*Math.PI);
            ctx.fillStyle = '#1f2535';
            ctx.fill();
            ctx.beginPath();
            ctx.arc(259, 241, 4, 0, 2*Math.PI);
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(243, 239, 1.8, 0, 2*Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.beginPath();
            ctx.arc(261, 239, 1.8, 0, 2*Math.PI);
            ctx.fill();
        }

        // цикл
        function loop() {
            move(vec.x * SPEED, vec.y * SPEED);
            draw();
            requestAnimationFrame(loop);
        }
        
        loop();
    })();
</script>
</body>
</html>