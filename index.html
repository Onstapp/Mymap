<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mymap ¬∑ PeerJS –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: #1a2a1a;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: monospace;
            padding: 10px;
        }
        #loginScreen {
            background: #2a3a2a;
            border-radius: 42px;
            padding: 30px 20px;
            box-shadow: 0 20px 30px #000000e0;
            color: #d0e0d0;
            width: min(400px, 100%);
        }
        h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 32px;
            text-shadow: 3px 3px 0 #1a2a1a;
            letter-spacing: 4px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            text-align: center;
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            background: #1a2a1a;
            border: 3px solid #4a7a4a;
            border-radius: 30px;
            color: #d0e0d0;
            font-size: 18px;
            font-family: monospace;
            outline: none;
            text-align: center;
        }
        .input-group input:focus {
            border-color: #7cb57c;
        }
        .color-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        .color-option {
            aspect-ratio: 1;
            border-radius: 15px;
            cursor: pointer;
            border: 3px solid transparent;
        }
        .color-option.selected {
            border-color: white;
            transform: scale(1.05);
            box-shadow: 0 0 15px white;
        }
        .color-white { background: #ffffff; }
        .color-black { background: #222222; }
        .color-red { background: #ff4444; }
        .color-orange { background: #ff8844; }
        .color-yellow { background: #ffff44; }
        .color-green { background: #44ff44; }
        .color-cyan { background: #44ffff; }
        .color-blue { background: #4444ff; }
        .color-pink { background: #ff88ff; }
        .color-purple { background: #aa44ff; }
        
        button {
            width: 100%;
            padding: 18px;
            background: #4a7a4a;
            border: none;
            border-radius: 40px;
            color: #d0e0d0;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 6px 0 #1a2a1a;
            margin: 10px 0;
            font-family: monospace;
            transition: 0.05s linear;
        }
        button:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #1a2a1a;
        }
        
        .panel {
            background: #1a2a1a;
            border-radius: 30px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #4a7a4a;
        }
        
        .code-display {
            font-size: 42px;
            font-weight: bold;
            color: #ffffa0;
            text-align: center;
            padding: 20px;
            background: #1a2a1a;
            border-radius: 20px;
            margin: 15px 0;
            letter-spacing: 8px;
            border: 3px solid #7cb57c;
        }
        
        #errorMsg {
            color: #ff8888;
            text-align: center;
            min-height: 25px;
            margin: 10px 0;
        }
        
        .status {
            text-align: center;
            color: #a0d0a0;
            font-size: 14px;
            margin: 10px 0;
        }
        
        #gameScreen {
            background: #2a3a2a;
            border-radius: 42px;
            padding: 20px;
            box-shadow: 0 20px 30px #000000e0;
            width: min(450px, 100%);
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .room-info {
            background: #1a2a1a;
            padding: 8px 15px;
            border-radius: 25px;
            color: #ffffa0;
            font-size: 18px;
            border: 2px solid #7cb57c;
        }
        
        .exit-btn {
            background: #4a3a3a;
            color: #ffb0b0;
            padding: 8px 20px;
            font-size: 16px;
            width: auto;
            box-shadow: 0 4px 0 #2a1a1a;
        }
        
        canvas {
            display: block;
            width: 100%;
            aspect-ratio: 1;
            background: #7cb57c;
            border-radius: 30px;
            box-shadow: inset 0 0 0 4px #4a7a4a;
            margin: 10px 0;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-btn {
            flex: 1;
            padding: 15px;
            background: #3a4a3a;
            border-radius: 25px;
            box-shadow: 0 5px 0 #1a2a1a;
            text-align: center;
            font-size: 24px;
            color: #ff6b6b;
            cursor: pointer;
        }
        .action-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #1a2a1a;
        }
        
        .joystick {
            flex: 2;
            background: #3a4a3a;
            border-radius: 999px;
            box-shadow: 0 5px 0 #1a2a1a, inset 0 -2px 8px #5a7a5a;
            position: relative;
            touch-action: none;
        }
        .thumb {
            position: absolute;
            width: 50px;
            height: 50px;
            background: #7cb57c;
            border-radius: 999px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 8px #1a2a1a, 0 0 0 3px #4a7a4a;
        }
        
        .player-list {
            color: #d0e0d0;
            font-size: 14px;
            background: #1a2a1a80;
            padding: 10px;
            border-radius: 15px;
            margin: 10px 0;
            border: 1px solid #5a7a5a;
            backdrop-filter: blur(2px);
        }
        
        .counter {
            color: #d0e0d0;
            font-size: 16px;
            text-align: center;
            margin: 10px 0;
        }
        
        .coords {
            color: #d0e0d0;
            font-size: 14px;
            text-align: center;
            margin: 5px 0;
        }
    </style>
    <!-- PeerJS -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
    <div id="loginScreen">
        <h2>MYMAP</h2>
        
        <div class="input-group">
            <label>–¢–í–û–Å –ò–ú–Ø</label>
            <input type="text" id="nameInput" maxlength="20" value="–ò–≥—Ä–æ–∫">
        </div>
        
        <div class="input-group">
            <label>–¶–í–ï–¢</label>
            <div class="color-grid" id="colorGrid"></div>
        </div>
        
        <div class="panel">
            <button id="createRoomBtn">üéÆ –°–û–ó–î–ê–¢–¨ –ò–ì–†–£</button>
            <div id="hostCode" class="code-display"></div>
            <div class="status">üëâ –ü–æ–∫–∞–∂–∏ —ç—Ç–æ—Ç –∫–æ–¥ –¥—Ä—É–≥—É</div>
        </div>
        
        <div class="panel">
            <input type="text" id="peerCodeInput" placeholder="–í–≤–µ–¥–∏ –∫–æ–¥ –¥—Ä—É–≥–∞" maxlength="10">
            <button id="connectBtn">üîå –ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø</button>
        </div>
        
        <div id="errorMsg"></div>
        <div class="status" id="connectionStatus">üü¢ PeerJS –≥–æ—Ç–æ–≤</div>
    </div>

    <div id="gameScreen" style="display: none;">
        <div class="game-header">
            <div class="room-info" id="roomCodeDisplay"></div>
            <button class="exit-btn" id="exitBtn">–í–´–•–û–î</button>
        </div>
        
        <canvas id="world" width="600" height="600"></canvas>
        
        <div class="coords" id="coordsDisplay">X: 0 | Y: 0</div>
        
        <div class="player-list" id="playerList"></div>
        <div class="counter" id="counter">0/10</div>
        
        <div class="controls">
            <div class="action-btn" id="createBtn">‚¨§</div>
            <div class="joystick" id="joystick">
                <div class="thumb" id="thumb"></div>
            </div>
            <div class="action-btn" id="deleteBtn">‚úï</div>
        </div>
    </div>

    <script>
        // –¶–≤–µ—Ç–∞
        const colors = [
            'white', 'black', 'red', 'orange', 'yellow',
            'green', 'cyan', 'blue', 'pink', 'purple'
        ];
        
        let selectedColor = 'white';
        let myId = null;
        let myName = '';
        let players = new Map();
        let playerObstacles = [];
        let peer = null;
        let conn = null;
        let isHost = false;
        let myPeerId = null;
        
        // –°–µ—Ç–∫–∞ —Ü–≤–µ—Ç–æ–≤
        const colorGrid = document.getElementById('colorGrid');
        colors.forEach(color => {
            const div = document.createElement('div');
            div.className = `color-option color-${color}`;
            if (color === 'white') div.classList.add('selected');
            div.onclick = () => {
                document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
                selectedColor = color;
            };
            colorGrid.appendChild(div);
        });
        
        // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
        const staticObstacles = [];
        for (let i = 0; i < 80; i++) {
            staticObstacles.push({
                x: (Math.random() - 0.5) * 1500,
                y: (Math.random() - 0.5) * 1500,
                w: 30 + Math.random() * 50,
                h: 30 + Math.random() * 50
            });
        }
        
        // –ò–≥—Ä–æ–∫
        const player = {
            x: 0,
            y: 0,
            r: 18
        };
        
        // –î–∂–æ–π—Å—Ç–∏–∫
        let drag = false;
        const maxDist = 35;
        const vec = { x: 0, y: 0 };
        const SPEED = 5;
        let lastDir = { x: 0, y: -1 };
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const canvas = document.getElementById('world');
        const ctx = canvas.getContext('2d');
        const joyDiv = document.getElementById('joystick');
        const thumbDiv = document.getElementById('thumb');
        const coordsDiv = document.getElementById('coordsDisplay');
        const createBtn = document.getElementById('createBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const counterDiv = document.getElementById('counter');
        const playerListDiv = document.getElementById('playerList');
        const exitBtn = document.getElementById('exitBtn');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const connectBtn = document.getElementById('connectBtn');
        const hostCode = document.getElementById('hostCode');
        const peerCodeInput = document.getElementById('peerCodeInput');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const connectionStatus = document.getElementById('connectionStatus');
        
        const MAX_PLAYER_OBSTACLES = 10;
        
        // ============== PEERJS –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==============
        function initPeer() {
            try {
                // –°–æ–∑–¥–∞–µ–º Peer —Å —Å–ª—É—á–∞–π–Ω—ã–º ID
                peer = new Peer();
                
                peer.on('open', (id) => {
                    myPeerId = id;
                    console.log('PeerJS ID:', id);
                    connectionStatus.innerHTML = 'üü¢ PeerJS –≥–æ—Ç–æ–≤<br>–¢–≤–æ–π ID: ' + id;
                });
                
                peer.on('connection', (connection) => {
                    console.log('–í—Ö–æ–¥—è—â–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                    conn = connection;
                    setupConnection();
                });
                
                peer.on('error', (error) => {
                    console.error('PeerJS error:', error);
                    connectionStatus.innerHTML = 'üî¥ –û—à–∏–±–∫–∞: ' + error.type;
                });
                
            } catch (e) {
                console.error('Init error:', e);
                connectionStatus.innerHTML = 'üî¥ –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏';
            }
        }
        
        // ============== –°–û–ó–î–ê–ù–ò–ï –ö–û–ú–ù–ê–¢–´ (–•–û–°–¢) ==============
        createRoomBtn.onclick = () => {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                document.getElementById('errorMsg').textContent = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
                return;
            }
            
            myName = name;
            isHost = true;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–π Peer ID –∫–∞–∫ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã
            hostCode.innerHTML = myPeerId || '–û–∂–∏–¥–∞–Ω–∏–µ...';
            roomCodeDisplay.innerHTML = '–ö–æ–¥: ' + myPeerId;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
            players.set(myPeerId, {
                id: myPeerId,
                name: myName,
                color: selectedColor,
                x: 0, y: 0,
                lastDir: { x: 0, y: -1 },
                r: 18,
                isHost: true
            });
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            updatePlayerList();
            updateCounter();
        };
        
        // ============== –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ö–û–ú–ù–ê–¢–ï ==============
        connectBtn.onclick = () => {
            const name = document.getElementById('nameInput').value.trim();
            const hostId = peerCodeInput.value.trim();
            
            if (!name) {
                document.getElementById('errorMsg').textContent = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
                return;
            }
            if (!hostId) {
                document.getElementById('errorMsg').textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥—Ä—É–≥–∞';
                return;
            }
            
            myName = name;
            isHost = false;
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Ö–æ—Å—Ç—É
            conn = peer.connect(hostId);
            
            conn.on('open', () => {
                console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Ö–æ—Å—Ç—É');
                setupConnection();
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
                sendData({
                    type: 'join',
                    player: {
                        id: myPeerId,
                        name: myName,
                        color: selectedColor,
                        x: 0, y: 0,
                        lastDir: { x: 0, y: -1 },
                        r: 18
                    }
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
                players.set(myPeerId, {
                    id: myPeerId,
                    name: myName,
                    color: selectedColor,
                    x: 0, y: 0,
                    lastDir: { x: 0, y: -1 },
                    r: 18,
                    isHost: false
                });
                
                roomCodeDisplay.innerHTML = '–ö–æ–¥: ' + hostId;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('gameScreen').style.display = 'block';
                updatePlayerList();
                updateCounter();
            });
            
            conn.on('error', (err) => {
                console.error('Connection error:', err);
                document.getElementById('errorMsg').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            });
        };
        
        // ============== –ù–ê–°–¢–†–û–ô–ö–ê –°–û–ï–î–ò–ù–ï–ù–ò–Ø ==============
        function setupConnection() {
            conn.on('data', (data) => {
                handleData(data);
            });
            
            conn.on('close', () => {
                console.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                connectionStatus.innerHTML = 'üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ';
            });
        }
        
        function sendData(data) {
            if (conn && conn.open) {
                conn.send(data);
            }
        }
        
        function handleData(data) {
            switch(data.type) {
                case 'join':
                    players.set(data.player.id, data.player);
                    updatePlayerList();
                    
                    // –ï—Å–ª–∏ –º—ã —Ö–æ—Å—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    if (isHost) {
                        sendData({
                            type: 'sync',
                            players: Array.from(players.values()),
                            obstacles: playerObstacles
                        });
                    }
                    break;
                    
                case 'move':
                    const p = players.get(data.id);
                    if (p) {
                        p.x = data.x;
                        p.y = data.y;
                        p.lastDir = data.lastDir;
                    }
                    break;
                    
                case 'createObstacle':
                    playerObstacles.push(data.obstacle);
                    updateCounter();
                    
                    // –ï—Å–ª–∏ —Ö–æ—Å—Ç, —Ä–∞—Å—Å—ã–ª–∞–µ–º –≤—Å–µ–º
                    if (isHost) {
                        sendData({
                            type: 'createObstacle',
                            obstacle: data.obstacle
                        });
                    }
                    break;
                    
                case 'deleteObstacle':
                    playerObstacles.splice(data.index, 1);
                    updateCounter();
                    
                    if (isHost) {
                        sendData({
                            type: 'deleteObstacle',
                            index: data.index
                        });
                    }
                    break;
                    
                case 'sync':
                    if (data.players) {
                        data.players.forEach(p => {
                            if (p.id !== myPeerId) {
                                players.set(p.id, p);
                            }
                        });
                    }
                    if (data.obstacles) {
                        playerObstacles = data.obstacles;
                    }
                    updatePlayerList();
                    updateCounter();
                    break;
            }
        }
        
        // ============== –í–´–•–û–î ==============
        exitBtn.onclick = () => {
            if (conn) {
                conn.close();
            }
            location.reload();
        };
        
        // ============== –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ==============
        function updatePlayerList() {
            const list = Array.from(players.values())
                .map(p => `<span style="color: ${getColor(p.color)}">‚óè</span> ${p.name}${p.id === myPeerId ? ' (–≤—ã)' : ''}${p.isHost ? ' üëë' : ''}`)
                .join('<br>');
            playerListDiv.innerHTML = `üë• –ò–≥—Ä–æ–∫–∏ (${players.size}):<br>${list}`;
        }
        
        function updateCounter() {
            const myObstacles = playerObstacles.filter(o => o.playerId === myPeerId).length;
            counterDiv.innerHTML = `‚¨§ ${myObstacles}/${MAX_PLAYER_OBSTACLES}`;
        }
        
        function updateCoords() {
            coordsDiv.textContent = `X: ${Math.round(player.x)} | Y: ${Math.round(player.y)}`;
        }
        
        function canMoveTo(nx, ny, r) {
            // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            for (let ob of staticObstacles) {
                const nearX = Math.max(ob.x, Math.min(nx, ob.x + ob.w));
                const nearY = Math.max(ob.y, Math.min(ny, ob.y + ob.h));
                const d = Math.hypot(nx - nearX, ny - nearY);
                if (d < r) return false;
            }
            
            // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –∏–≥—Ä–æ–∫–æ–≤
            for (let ob of playerObstacles) {
                const nearX = Math.max(ob.x, Math.min(nx, ob.x + ob.w));
                const nearY = Math.max(ob.y, Math.min(ny, ob.y + ob.h));
                const d = Math.hypot(nx - nearX, ny - nearY);
                if (d < r) return false;
            }
            
            // –î—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏
            for (let p of players.values()) {
                if (p.id === myPeerId) continue;
                const d = Math.hypot(nx - p.x, ny - p.y);
                if (d < r + 18) return false;
            }
            
            return true;
        }
        
        function move(dx, dy) {
            if (dx === 0 && dy === 0) return;
            
            let moved = false;
            
            if (canMoveTo(player.x + dx, player.y + dy, player.r)) {
                player.x += dx;
                player.y += dy;
                moved = true;
            } else {
                if (canMoveTo(player.x + dx, player.y, player.r)) {
                    player.x += dx;
                    moved = true;
                }
                if (canMoveTo(player.x, player.y + dy, player.r)) {
                    player.y += dy;
                    moved = true;
                }
            }
            
            if (moved) {
                sendData({
                    type: 'move',
                    id: myPeerId,
                    x: player.x,
                    y: player.y,
                    lastDir: lastDir
                });
            }
        }
        
        function createObstacle() {
            const myObstacles = playerObstacles.filter(o => o.playerId === myPeerId).length;
            if (myObstacles >= MAX_PLAYER_OBSTACLES) return;
            
            const len = Math.hypot(lastDir.x, lastDir.y);
            if (len < 0.1) return;
            
            const dirX = lastDir.x / len;
            const dirY = lastDir.y / len;
            
            const newX = player.x + dirX * 50;
            const newY = player.y + dirY * 50;
            
            const obstacle = {
                playerId: myPeerId,
                playerColor: selectedColor,
                x: newX - 20,
                y: newY - 20,
                w: 40,
                h: 40
            };
            
            playerObstacles.push(obstacle);
            sendData({ type: 'createObstacle', obstacle });
            updateCounter();
        }
        
        function deleteObstacle() {
            for (let i = playerObstacles.length - 1; i >= 0; i--) {
                if (playerObstacles[i].playerId === myPeerId) {
                    playerObstacles.splice(i, 1);
                    sendData({ type: 'deleteObstacle', index: i });
                    updateCounter();
                    return;
                }
            }
        }
        
        // ============== –î–ñ–û–ô–°–¢–ò–ö ==============
        function onStart(e) {
            e.preventDefault();
            drag = true;
            onMove(e);
        }
        
        function onMove(e) {
            if (!drag) return;
            e.preventDefault();
            
            const rect = joyDiv.getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            
            let x, y;
            if (e.touches) {
                x = e.touches[0].clientX;
                y = e.touches[0].clientY;
            } else {
                x = e.clientX;
                y = e.clientY;
            }
            
            let dx = x - cx;
            let dy = y - cy;
            const dist = Math.hypot(dx, dy);
            
            if (dist > maxDist) {
                dx = (dx / dist) * maxDist;
                dy = (dy / dist) * maxDist;
            }
            
            thumbDiv.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            
            if (dist > 0.1) {
                vec.x = dx / maxDist;
                vec.y = dy / maxDist;
                lastDir.x = vec.x;
                lastDir.y = vec.y;
            } else {
                vec.x = 0;
                vec.y = 0;
            }
        }
        
        function onEnd(e) {
            e.preventDefault();
            drag = false;
            thumbDiv.style.transform = 'translate(-50%, -50%)';
            vec.x = 0;
            vec.y = 0;
        }
        
        // ============== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==============
        createBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            createObstacle();
        });
        createBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            createObstacle();
        });
        
        deleteBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            deleteObstacle();
        });
        deleteBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            deleteObstacle();
        });
        
        joyDiv.addEventListener('mousedown', onStart);
        joyDiv.addEventListener('mousemove', onMove);
        joyDiv.addEventListener('mouseup', onEnd);
        joyDiv.addEventListener('mouseleave', onEnd);
        
        joyDiv.addEventListener('touchstart', onStart, { passive: false });
        joyDiv.addEventListener('touchmove', onMove, { passive: false });
        joyDiv.addEventListener('touchend', onEnd);
        joyDiv.addEventListener('touchcancel', onEnd);
        
        function getColor(colorName) {
            const colors = {
                'white': '#ffffff', 'black': '#222222', 'red': '#ff4444',
                'orange': '#ff8844', 'yellow': '#ffff44', 'green': '#44ff44',
                'cyan': '#44ffff', 'blue': '#4444ff', 'pink': '#ff88ff',
                'purple': '#aa44ff'
            };
            return colors[colorName] || '#7fd4ff';
        }
        
        // ============== –†–ò–°–û–í–ê–ù–ò–ï ==============
        function draw() {
            ctx.clearRect(0, 0, 600, 600);
            
            const camX = player.x - 300;
            const camY = player.y - 300;
            
            // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            ctx.fillStyle = '#5a4f4a';
            ctx.shadowColor = '#3a2f2a';
            ctx.shadowBlur = 15;
            
            staticObstacles.forEach(ob => {
                const x = ob.x - camX;
                const y = ob.y - camY;
                if (x > -100 && x < 700 && y > -100 && y < 700) {
                    ctx.fillRect(x, y, ob.w, ob.h);
                }
            });
            
            // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –∏–≥—Ä–æ–∫–æ–≤
            playerObstacles.forEach(ob => {
                const x = ob.x - camX;
                const y = ob.y - camY;
                if (x > -100 && x < 700 && y > -100 && y < 700) {
                    ctx.shadowColor = '#2a7080';
                    ctx.beginPath();
                    ctx.arc(x + ob.w/2, y + ob.h/2, ob.w/2, 0, Math.PI*2);
                    ctx.fillStyle = getColor(ob.playerColor);
                    ctx.fill();
                    ctx.strokeStyle = '#3f7080';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            });
            
            // –î—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏
            players.forEach(p => {
                if (p.id === myPeerId) return;
                
                const x = 300 + (p.x - player.x);
                const y = 300 + (p.y - player.y);
                
                if (x > -50 && x < 650 && y > -50 && y < 650) {
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = '#4aa0c0';
                    ctx.beginPath();
                    ctx.arc(x, y, 18, 0, Math.PI*2);
                    ctx.fillStyle = getColor(p.color);
                    ctx.fill();
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    ctx.shadowBlur = 4;
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 12px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText(p.name, x, y - 25);
                }
            });
            
            // –Ø
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#4aa0c0';
            ctx.beginPath();
            ctx.arc(300, 300, 18, 0, Math.PI*2);
            ctx.fillStyle = getColor(selectedColor);
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.shadowBlur = 4;
            ctx.fillStyle = 'white';
            ctx.font = 'bold 12px monospace';
            ctx.textAlign = 'center';
            ctx.fillText(myName + (isHost ? ' üëë' : ''), 300, 275);
            
            // –¢–æ—á–∫–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const len = Math.hypot(lastDir.x, lastDir.y);
            if (len > 0.1) {
                const dirX = lastDir.x / len;
                const dirY = lastDir.y / len;
                const dotX = 300 + dirX * 45;
                const dotY = 300 + dirY * 45;
                
                ctx.shadowBlur = 0;
                ctx.beginPath();
                ctx.arc(dotX, dotY, 6, 0, Math.PI*2);
                ctx.fillStyle = '#6a6a6a';
                ctx.fill();
            }
            
            ctx.shadowBlur = 0;
        }
        
        function gameLoop() {
            if (drag) {
                move(vec.x * SPEED, vec.y * SPEED);
            }
            updateCoords();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        initPeer();
        gameLoop();
    </script>
</body>
</html>